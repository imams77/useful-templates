# Common, version-agnostic service definition (hybrid strategy)
# Use per-version override files to pin exact images/tags for reproducibility.

services:
  php:
    # Default (can be overridden by env/PHP_IMAGE or per-version compose)
    image: "${PHP_IMAGE:-php:8.2-fpm-alpine}"
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - ./www:/var/www/html:delegated
      - ./php.ini:/usr/local/etc/php/conf.d/local.ini:ro
    ports:
      - "${PHP_FPM_PORT:-9000}:9000" # useful when exposing FPM for proxying/tests
    environment:
      - COMPOSER_ALLOW_SUPERUSER=1
    healthcheck:
      test: ["CMD", "php", "-v"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"

# Usage notes:
# - To run a pinned version: `docker compose -f docker-compose.yml -f docker-compose.php8.4.yml up -d`
# - To run the default version (from .env or PHP_IMAGE): `docker compose up -d`
# - To run multiple versions concurrently, pass a different project name: 
#     `COMPOSE_PROJECT_NAME=php82 docker compose -f docker-compose.yml -f docker-compose.php8.2.yml up -d`
